<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marks & Results Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .grade-badge { padding: 4px 10px; border-radius: 8px; font-weight: 700; font-size: 0.8rem; letter-spacing: 0.5px; }
        .grade-A-plus { background-color: #059669; color: white; box-shadow: 0 2px 5px rgba(5, 150, 105, 0.3); }
        .grade-A { background-color: #10b981; color: white; }
        .grade-B { background-color: #3b82f6; color: white; }
        .grade-C { background-color: #f59e0b; color: white; }
        .grade-D { background-color: #f97316; color: white; }
        .grade-F { background-color: #ef4444; color: white; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex; align-items: center; justify-content: center; z-index: 1000;
            backdrop-filter: blur(2px);
        }
        .modal-content {
            background: white; border-radius: 16px; max-width: 650px; width: 95%;
            max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        @keyframes bounce-slow {
            0%, 100% { transform: translateY(-5%); }
            50% { transform: translateY(5%); }
        }
        .animate-bounce-slow { animation: bounce-slow 2s infinite; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-6 font-sans text-slate-800">
    <script>
        const FASTAPI_URL = "http://127.0.0.1:8000";
        const courseCode = new URLSearchParams(window.location.search).get('course');
        let marksData = [];

        document.addEventListener('DOMContentLoaded', async () => {
            if (courseCode) {
                document.getElementById('courseTitle').textContent = `${courseCode} - Marks & Results`;
                await loadMarks(); // Load marks data
                await loadResults(); // Load calculated results
            } else {
                alert("No course selected.");
                window.location.href = 'teacher.html';
            }
        });

        function backToDashboard() {
            window.location.href = 'teacher.html';
        }

       // --- LOAD MARKS DATA ---
async function loadMarks() {
    const tbody = document.getElementById('marksTableBody');
    
    tbody.innerHTML = '<tr><td colspan="12" class="text-center py-12 text-slate-400"><i class="fa-solid fa-circle-notch fa-spin text-2xl mb-2 text-indigo-500"></i><br>Loading marks...</td></tr>';

    try {
        const response = await fetch(`${FASTAPI_URL}/marks/${courseCode}`);
        if (response.ok) {
            marksData = await response.json();
            // Debug: Check if assignment marks are in the data
            console.log("Loaded marks data:", marksData);
            if (marksData.length > 0) {
                console.log("First student assignment:", marksData[0].assignment);
            }
            renderMarksTable();
        } else {
            marksData = [];
            renderMarksTable();
        }
    } catch (error) {
        console.error('Error loading marks:', error);
        marksData = [];
        renderMarksTable();
    }
}

        // --- LOAD CALCULATED RESULTS ---
        async function loadResults() {
            try {
                const response = await fetch(`${FASTAPI_URL}/results/${courseCode}`);
                if (response.ok) {
                    const results = await response.json();
                    renderResultsInTable(results);
                }
            } catch (error) {
                console.error('Error loading results:', error);
                // Results will be calculated when needed
            }
        }

        // --- RENDER MARKS TABLE ---
        function renderMarksTable() {
            const tbody = document.getElementById('marksTableBody');
            const countSpan = document.getElementById('studentCount');
            countSpan.innerText = `${marksData.length} Students`;
            
            if (marksData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="12" class="text-center py-16 text-slate-400 border-dashed border-2 border-slate-200 rounded-lg bg-slate-50/50">
                            <i class="fa-solid fa-folder-open text-4xl mb-3 text-slate-300"></i>
                            <p class="font-medium">No marks data found.</p>
                            <p class="text-sm opacity-70 mb-4">Upload a marks file or add students manually.</p>
                            <div class="flex gap-3 justify-center">
                                <button onclick="document.getElementById('uploadSection').classList.remove('hidden')" class="text-indigo-600 hover:text-indigo-700 font-bold bg-indigo-50 px-4 py-2 rounded-lg transition">Upload File</button>
                                <button onclick="openEditModal()" class="text-green-600 hover:text-green-700 font-bold bg-green-50 px-4 py-2 rounded-lg transition">Add Student</button>
                            </div>
                        </td>
                    </tr>`;
                return;
            }

            tbody.innerHTML = marksData.map((s, index) => `
                <tr class="border-b border-slate-100 hover:bg-slate-50 transition text-sm group">
                    <td class="px-4 py-4 font-bold text-slate-700">${s.rollno || '-'}</td>
                    <td class="px-4 py-4 font-medium text-slate-600">${s.name || '-'}</td>
                    
                    <td class="px-2 py-4 text-center text-slate-500">${formatMark(s.sessional)}</td>
                    <td class="px-2 py-4 text-center text-slate-500">${formatMark(s.assignment)}</td>
                    <td class="px-2 py-4 text-center text-slate-500">${formatMark(s.quiz)}</td>
                    <td class="px-2 py-4 text-center font-semibold text-indigo-600 bg-indigo-50/30 rounded">${formatMark(s.mids_marks)}</td>
                    <td class="px-2 py-4 text-center font-semibold text-purple-600 bg-purple-50/30 rounded">${formatMark(s.finals_marks)}</td>
                    
                    <!-- These columns will be populated by results -->
                    <td class="px-2 py-4 text-center font-bold text-slate-800 bg-gray-50 border-l border-gray-100" id="total-${s.rollno}">-</td>
                    <td class="px-2 py-4 text-center text-slate-700 bg-gray-50" id="percentage-${s.rollno}">-</td>
                    <td class="px-2 py-4 text-center font-bold text-slate-800 bg-gray-50" id="gpa-${s.rollno}">-</td>
                    <td class="px-2 py-4 text-center bg-gray-50 border-r border-gray-100" id="grade-${s.rollno}">
                        <span class="text-xs text-gray-400">N/A</span>
                    </td>
                    
                    <td class="px-4 py-4 text-center">
                        <div class="flex items-center justify-center gap-2 opacity-80 group-hover:opacity-100 transition">
                            <button onclick="openEditModal(${index})" class="text-blue-500 hover:text-white hover:bg-blue-500 p-2 rounded-lg transition shadow-sm border border-blue-100" title="Edit Record">
                                <i class="fa-solid fa-pen"></i>
                            </button>
                            <button onclick="deleteMarks('${s.rollno}')" class="text-rose-500 hover:text-white hover:bg-rose-500 p-2 rounded-lg transition shadow-sm border border-rose-100" title="Delete Record">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // --- RENDER RESULTS IN TABLE ---
        function renderResultsInTable(results) {
            results.forEach(result => {
                const rollno = result.rollno;
                if (rollno) {
                    const totalCell = document.getElementById(`total-${rollno}`);
                    const percentageCell = document.getElementById(`percentage-${rollno}`);
                    const gpaCell = document.getElementById(`gpa-${rollno}`);
                    const gradeCell = document.getElementById(`grade-${rollno}`);
                    
                    if (totalCell) totalCell.textContent = result.total_marks !== undefined ? result.total_marks.toFixed(1) : '-';
                    if (percentageCell) percentageCell.textContent = result.percentage !== undefined ? result.percentage.toFixed(1) + '%' : '-';
                    if (gpaCell) gpaCell.textContent = result.gpa !== undefined ? result.gpa.toFixed(2) : '-';
                    if (gradeCell) {
                        if (result.grade) {
                            gradeCell.innerHTML = `<span class="grade-badge ${getGradeClass(result.grade)}">${result.grade}</span>`;
                        } else {
                            gradeCell.innerHTML = '<span class="text-xs text-gray-400">N/A</span>';
                        }
                    }
                }
            });
        }

        function formatMark(val) {
            return (val === undefined || val === null) ? '-' : val.toString();
        }

        function getGradeClass(grade) {
            if (!grade) return '';
            if (grade.includes('A+')) return 'grade-A-plus';
            if (grade.includes('A')) return 'grade-A';
            if (grade.includes('B')) return 'grade-B';
            if (grade.includes('C')) return 'grade-C';
            if (grade.includes('D')) return 'grade-D';
            return 'grade-F';
        }

        // --- CALCULATE RESULTS (USES result.py) ---
        async function calculateResults() {
            const btn = document.getElementById('calcBtn');
            const icon = document.getElementById('calcIcon');
            const text = document.getElementById('calcText');
            
            if (!courseCode) {
                alert('Please select a course first.');
                return;
            }
            
            btn.disabled = true;
            icon.className = 'fa-solid fa-gear fa-spin text-3xl mb-3';
            text.innerHTML = "Processing...";
            text.classList.add("animate-pulse");

            try {
                // Call result.py calculate endpoint
                const response = await fetch(`${FASTAPI_URL}/results/calculate/${courseCode}`, { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showMessage(`✅ Results calculated for ${data.students_processed || data.results?.length || 0} students!`, "success");
                    // Reload results to display them
                    await loadResults();
                } else {
                    const error = await response.json();
                    throw new Error(error.detail || 'Calculation failed');
                }
            } catch (e) {
                console.error('Calculation error:', e);
                showMessage('❌ Error calculating results: ' + e.message, "error");
            } finally {
                setTimeout(() => {
                    btn.disabled = false;
                    icon.className = 'fa-solid fa-calculator text-3xl mb-3 group-hover:scale-110 transition-transform';
                    text.innerHTML = "Calculate Results";
                    text.classList.remove("animate-pulse");
                }, 800);
            }
        }

        // --- EXPORT RESULTS (USES result.py) ---
        function exportResults() {
            if (!courseCode) {
                alert('Please select a course first.');
                return;
            }
            
            const icon = document.getElementById('exportIcon');
            icon.classList.add('fa-spin');
            
            try {
                // Open result.py export endpoint
                window.open(`${FASTAPI_URL}/results/export/${courseCode}`, '_blank');
            } catch (e) {
                console.error('Export error:', e);
                alert('Error exporting results: ' + e.message);
            } finally {
                setTimeout(() => {
                    icon.classList.remove('fa-spin');
                }, 1000);
            }
        }

       // --- UPLOAD FILE (USES upload.py) ---
async function uploadMarks(e) {
    e.preventDefault();
    
    if (!courseCode) {
        alert('Please select a course first.');
        return;
    }
    
    const fileInput = document.getElementById('marksFile');
    const file = fileInput.files[0];
    const btn = document.getElementById('uploadActionBtn');

    if (!file) { 
        alert("Please select a file first."); 
        return; 
    }

    const formData = new FormData();
    formData.append('file', file);
    formData.append('course_code', courseCode);

    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Uploading...';
    btn.disabled = true;

    try {
        // Call upload/marks endpoint (from upload.py)
        const res = await fetch(`${FASTAPI_URL}/upload/marks`, { 
            method: 'POST', 
            body: formData 
        });
        
        if (res.ok) {
            const data = await res.json();
            showMessage(`✅ Marks uploaded successfully! ${data.students_processed} students processed.`, "success");
            document.getElementById('uploadSection').classList.add('hidden');

            // After upload success
              await fetch(`${FASTAPI_URL}/results/calculate/${courseCode}`, {
              method: 'POST'
               });
            
            // IMPORTANT: Reload marks AND results after upload
            await loadMarks(); // Reload marks data
            await loadResults(); // Reload calculated results
            
        } else {
            const errorData = await res.json().catch(() => ({ detail: 'Unknown error' }));
            alert(`❌ Upload Failed: ${errorData.detail || "Check file format (requires 'rollno' column)"}`);
        }
    } catch (e) {
        console.error('Upload error:', e);
        alert(`❌ Network Error: Ensure API is running at ${FASTAPI_URL}\n\nError: ${e.message}`);
    } finally {
        btn.innerHTML = '<i class="fa-solid fa-cloud-arrow-up mr-2"></i> Upload & Process';
        btn.disabled = false;
        fileInput.value = '';
    }
}

        // --- MODAL LOGIC (USES marks.py save endpoint) ---
        function openEditModal(index = null) {
            const modal = document.getElementById('editModal');
            modal.classList.remove('hidden');
            
            if (index !== null && marksData[index]) {
                const s = marksData[index];
                document.getElementById('modalTitle').innerText = "Edit Student Marks";
                document.getElementById('editRollNo').value = s.rollno || '';
                document.getElementById('editRollNo').readOnly = true;
                document.getElementById('editName').value = s.name || '';
                document.getElementById('editMids').value = s.mids_marks || 0;
                document.getElementById('editFinals').value = s.finals_marks || 0;
                document.getElementById('editSess').value = s.sessional || 0;
                document.getElementById('editAssg').value = s.assignment || 0;
                document.getElementById('editQuiz').value = s.quiz || 0;
            } else {
                document.getElementById('modalTitle').innerText = "Add New Student Record";
                document.getElementById('editForm').reset();
                document.getElementById('editRollNo').readOnly = false;
                document.getElementById('editRollNo').value = '';
                document.getElementById('editName').value = '';
                document.getElementById('editMids').value = 0;
                document.getElementById('editFinals').value = 0;
                document.getElementById('editSess').value = 0;
                document.getElementById('editAssg').value = 0;
                document.getElementById('editQuiz').value = 0;
            }
        }

        function closeModal() {
            document.getElementById('editModal').classList.add('hidden');
        }

        async function saveMarkEntry(e) {
            e.preventDefault();
            
            if (!courseCode) {
                alert('Please select a course first.');
                return;
            }
            
            const payload = {
                course_code: courseCode,
                rollno: document.getElementById('editRollNo').value.trim(),
                name: document.getElementById('editName').value.trim(),
                mids_marks: parseFloat(document.getElementById('editMids').value) || 0,
                finals_marks: parseFloat(document.getElementById('editFinals').value) || 0,
                sessional: parseFloat(document.getElementById('editSess').value) || 0,
                assignment: parseFloat(document.getElementById('editAssg').value) || 0,
                quiz: parseFloat(document.getElementById('editQuiz').value) || 0
            };

            if (!payload.rollno) {
                alert('Roll number is required.');
                return;
            }

            try {
                // Call marks.py save endpoint
                const res = await fetch(`${FASTAPI_URL}/marks/save`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                
                if(res.ok) {
                    closeModal();
                    showMessage("✅ Record saved successfully!", "success");
                    await loadMarks(); // Reload marks
                } else {
                    const error = await res.json().catch(() => ({ detail: 'Failed to save' }));
                    alert("❌ Failed to save: " + (error.detail || 'Unknown error'));
                }
            } catch(e) { 
                console.error('Save error:', e);
                alert("❌ Network Error: " + e.message); 
            }
        }

        // --- DELETE MARKS (USES marks.py delete endpoint) ---
        async function deleteMarks(rollno) {
            if(!confirm(`⚠️ Are you sure you want to delete marks for ${rollno}?`)) return;
            
            if (!courseCode) {
                alert('Please select a course first.');
                return;
            }
            
            try {
                const res = await fetch(`${FASTAPI_URL}/marks/delete`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ course_code: courseCode, rollno: rollno })
                });
                
                if(res.ok) {
                    showMessage("✅ Marks deleted successfully.", "success");
                    await loadMarks(); // Reload marks
                } else {
                    const error = await res.json().catch(() => ({ detail: 'Failed to delete' }));
                    alert("❌ Failed to delete: " + error.detail);
                }
            } catch(e) { 
                console.error('Delete error:', e);
                alert("❌ Network Error: " + e.message); 
            }
        }

        // --- DELETE ALL MARKS ---
        async function deleteAllMarks() {
            if (marksData.length === 0) {
                alert("Table is already empty!");
                return;
            }
            
            const confirmed = confirm(`⚠️ WARNING: This will delete ALL marks for ${courseCode}!\n\n${marksData.length} student records will have their marks cleared.\n\nAre you sure?`);
            
            if (!confirmed) return;
            
            try {
                showMessage("Clearing all marks...", "info");
                
                // Delete marks for each student
                const deletePromises = marksData.map(async (student) => {
                    try {
                        const response = await fetch(`${FASTAPI_URL}/marks/delete`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                course_code: courseCode,
                                rollno: student.rollno
                            })
                        });
                        return response.ok;
                    } catch (error) {
                        console.error(`Error deleting ${student.rollno}:`, error);
                        return false;
                    }
                });
                
                // Wait for all deletions to complete
                const results = await Promise.all(deletePromises);
                const successful = results.filter(r => r).length;
                
                // Clear local data
                marksData = [];
                renderMarksTable();
                
                showMessage(`✅ Cleared marks for ${successful} students!`, "success");
                
            } catch (error) {
                console.error('Error deleting all marks:', error);
                showMessage('❌ Error clearing marks. Please try again.', "error");
            }
        }

        function showMessage(msg, type) {
            const box = document.getElementById('messageBox');
            box.innerHTML = `<div class="flex items-center gap-3"><i class="fa-solid ${type==='success'?'fa-circle-check':'fa-triangle-exclamation'} text-2xl"></i><div><h4 class="font-bold text-sm uppercase">${type}</h4><p class="text-sm">${msg}</p></div></div>`;
            box.className = `fixed bottom-5 right-5 px-6 py-4 rounded-xl shadow-2xl text-white transition-all transform translate-y-0 opacity-100 z-50 ${type === 'success' ? 'bg-emerald-600' : 'bg-rose-600'}`;
            box.classList.remove('hidden');
            setTimeout(() => box.classList.add('hidden'), 3500);
        }

        // --- EMPTY TABLE FUNCTION ---
        async function emptyTable() {
            if (marksData.length === 0) {
                alert("Table is already empty!");
                return;
            }
            
            const userInput = prompt(`⚠️ DANGER: This will DELETE ALL data for ${courseCode}!\n\nType "DELETE ALL" to confirm:`);
            if (userInput !== "DELETE ALL") {
                alert("Cancelled. No data was deleted.");
                return;
            }
            
            try {
                const response = await fetch(`${FASTAPI_URL}/courses/${courseCode}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    // Clear local data
                    marksData = [];
                    renderMarksTable();
                    showMessage(`✅ All data for ${courseCode} has been deleted!`, "success");
                } else {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to delete');
                }
            } catch (error) {
                console.error('Error deleting course:', error);
                showMessage('❌ Error: ' + error.message, "error");
            }
        }
    </script>

    <div class="max-w-[95%] mx-auto fade-in pb-10">
        
        <!-- Header -->
        <div class="bg-white rounded-2xl shadow-sm p-6 mb-8 border border-slate-200 flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <div class="flex items-center gap-3 mb-1">
                    <h1 class="text-3xl font-extrabold text-slate-800 tracking-tight" id="courseTitle">Marks Management</h1>
                </div>
                <p class="text-slate-500 text-sm">Manage student assessments, calculate GPA, and publish results.</p>
            </div>
            
            <div class="flex gap-3">
                <button onclick="backToDashboard()" class="text-slate-500 hover:text-indigo-600 font-semibold text-sm transition flex items-center gap-2 border border-slate-200 px-4 py-2 rounded-lg bg-slate-50">
                    <i class="fa-solid fa-arrow-left"></i> Back to Dashboard
                </button>
            </div>
        </div>

        <!-- Quick Actions Grid -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            
            <!-- 1. Calculate Results (result.py) -->
            <button id="calcBtn" onclick="calculateResults()" class="bg-gradient-to-br from-emerald-500 to-emerald-600 hover:to-emerald-700 text-white rounded-2xl p-6 flex flex-col items-center justify-center shadow-lg shadow-emerald-100 transition transform hover:-translate-y-1 group">
                <i id="calcIcon" class="fa-solid fa-calculator text-3xl mb-3 group-hover:scale-110 transition-transform"></i>
                <span id="calcText" class="font-bold text-lg">Calculate Results</span>
                <span class="text-xs opacity-80 mt-1">Using result.py API</span>
            </button>

            <!-- 2. Export Results (result.py) -->
            <button onclick="exportResults()" class="bg-gradient-to-br from-blue-500 to-blue-600 hover:to-blue-700 text-white rounded-2xl p-6 flex flex-col items-center justify-center shadow-lg shadow-blue-100 transition transform hover:-translate-y-1 group">
                <i id="exportIcon" class="fa-solid fa-file-export text-3xl mb-3 group-hover:scale-110 transition-transform"></i>
                <span class="font-bold text-lg">Export Report</span>
                <span class="text-xs opacity-80 mt-1">Download CSV (result.py)</span>
            </button>

            <!-- 3. Bulk Upload Toggle (upload.py) -->
            <button onclick="document.getElementById('uploadSection').classList.toggle('hidden')" class="bg-gradient-to-br from-purple-500 to-purple-600 hover:to-purple-700 text-white rounded-2xl p-6 flex flex-col items-center justify-center shadow-lg shadow-purple-100 transition transform hover:-translate-y-1 group">
                <i class="fa-solid fa-cloud-arrow-up text-3xl mb-3 animate-bounce-slow"></i>
                <span class="font-bold text-lg">Bulk Upload</span>
                <span class="text-xs opacity-80 mt-1">Upload via upload.py</span>
            </button>

        </div>

        <!-- Upload Section (Hidden) -->
        <div id="uploadSection" class="hidden bg-white rounded-2xl border border-slate-200 p-8 mb-8 shadow-md relative overflow-hidden transition-all">
            <div class="absolute top-0 left-0 w-1.5 h-full bg-purple-500"></div>
            <h2 class="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2"><i class="fa-solid fa-file-csv text-purple-500"></i> Upload Marks File</h2>
            <form onsubmit="uploadMarks(event)" class="flex flex-col md:flex-row gap-6 items-end">
                <div class="flex-1 w-full">
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Select CSV/Excel File</label>
                    <input type="file" id="marksFile" accept=".csv,.xlsx,.xls" class="w-full text-sm text-slate-500 file:mr-4 file:py-3 file:px-6 file:rounded-xl file:border-0 file:text-sm file:font-bold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100 border border-slate-200 rounded-xl p-2 cursor-pointer bg-slate-50" required>
                </div>
                <button id="uploadActionBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-8 py-3.5 rounded-xl font-bold shadow-md transition whitespace-nowrap">
                    <i class="fa-solid fa-cloud-arrow-up mr-2"></i> Upload & Process
                </button>
            </form>
            <div class="mt-4 p-4 bg-blue-50 rounded-xl border border-blue-100 text-xs text-blue-700 flex items-start gap-3">
                <i class="fa-solid fa-circle-info text-base mt-0.5"></i>
                <div>
                    <p class="font-bold mb-1">File Format Instructions:</p>
                    <p>File must contain a <b>rollno</b> column. Optional columns: <b>mids_marks, finals_marks, quiz, assignment, sessional</b>.</p>
                    <p class="mt-2"><b>Sample CSV format:</b> rollno,name,section,sessional,assignment,quiz,mids_marks,finals_marks,batch</p>
                </div>
            </div>
        </div>

        <!-- Table Card -->
        <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
            
            <div class="p-6 border-b border-slate-100 flex flex-col sm:flex-row justify-between items-center gap-4 bg-slate-50/50">
                <div class="flex items-center gap-3">
                    <h2 class="text-xl font-bold text-slate-800">Marks Data (from marks.py)</h2>
                    <span class="bg-slate-200 text-slate-600 px-3 py-1 rounded-full text-xs font-bold" id="studentCount">0 Students</span>
                </div>
                
                <!-- UPDATED BUTTONS WITH DELETE ALL -->
                <div class="flex gap-2">
                    <button onclick="loadMarks()" class="bg-slate-200 hover:bg-slate-300 text-slate-700 px-4 py-2.5 rounded-xl text-sm font-bold transition flex items-center gap-2">
                        <i class="fa-solid fa-rotate-right"></i> Refresh
                    </button>
                    <button onclick="openEditModal()" class="bg-indigo-600 text-white hover:bg-indigo-700 px-5 py-2.5 rounded-xl text-sm font-bold transition flex items-center gap-2 shadow-sm">
                        <i class="fa-solid fa-plus"></i> Add Student
                    </button>
                    <button onclick="deleteAllMarks()" class="bg-rose-500 text-white hover:bg-rose-600 px-5 py-2.5 rounded-xl text-sm font-bold transition flex items-center gap-2 shadow-sm">
                        <i class="fa-solid fa-trash-can"></i> Clear All Marks
                    </button>
                    <button onclick="emptyTable()" class="bg-red-700 text-white hover:bg-red-800 px-5 py-2.5 rounded-xl text-sm font-bold transition flex items-center gap-2 shadow-sm">
                        <i class="fa-solid fa-bomb"></i> Delete Everything
                    </button>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-50 text-slate-500 text-xs uppercase font-bold tracking-wider">
                        <tr>
                            <th class="px-4 py-4 rounded-tl-xl">Roll No</th>
                            <th class="px-4 py-4">Name</th>
                            <th class="px-2 py-4 text-center">Sess</th>
                            <th class="px-2 py-4 text-center">Assg</th>
                            <th class="px-2 py-4 text-center">Quiz</th>
                            <th class="px-2 py-4 text-center text-indigo-600">Mids</th>
                            <th class="px-2 py-4 text-center text-purple-600">Finals</th>
                            
                            <!-- Results Columns (populated by result.py) -->
                            <th class="px-2 py-4 text-center bg-gray-100 text-slate-800 border-l border-gray-200">Total</th>
                            <th class="px-2 py-4 text-center bg-gray-100 text-slate-800">%</th>
                            <th class="px-2 py-4 text-center bg-gray-100 text-slate-800">GPA</th>
                            <th class="px-2 py-4 text-center bg-gray-100 text-slate-800 border-r border-gray-200">Grade</th>
                            
                            <th class="px-4 py-4 text-center rounded-tr-xl">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="marksTableBody" class="text-sm divide-y divide-slate-100 bg-white">
                        <!-- Javascript will populate rows -->
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- Edit/Add Modal (uses marks.py save) -->
    <div id="editModal" class="hidden modal-overlay fade-in">
        <div class="modal-content p-8 relative">
            <button onclick="closeModal()" class="absolute top-5 right-5 text-slate-400 hover:text-slate-600 transition bg-slate-100 hover:bg-slate-200 w-8 h-8 rounded-full flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            
            <h2 id="modalTitle" class="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-2">
                <i class="fa-solid fa-pen-to-square text-indigo-500"></i> Edit Marks
            </h2>
            
            <form id="editForm" onsubmit="saveMarkEntry(event)" class="space-y-6">
                <div class="grid grid-cols-2 gap-5">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1.5">Roll No *</label>
                        <input id="editRollNo" class="w-full border border-slate-200 bg-slate-50 rounded-xl px-4 py-2.5 outline-none focus:ring-2 focus:ring-indigo-500 font-medium transition" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1.5">Name</label>
                        <input id="editName" class="w-full border border-slate-200 rounded-xl px-4 py-2.5 outline-none focus:ring-2 focus:ring-indigo-500 transition">
                    </div>
                </div>
                
                <div class="p-5 bg-slate-50 rounded-2xl border border-slate-100">
                    <h3 class="text-sm font-bold text-slate-700 mb-4 border-b border-slate-200 pb-2">Assessments</h3>
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Sessional</label>
                            <input type="number" step="0.1" min="0" max="20" id="editSess" class="w-full border border-slate-200 rounded-lg p-2 text-center outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Assignmt</label>
                            <input type="number" step="0.1" min="0" max="10" id="editAssg" class="w-full border border-slate-200 rounded-lg p-2 text-center outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Quiz</label>
                            <input type="number" step="0.1" min="0" max="10" id="editQuiz" class="w-full border border-slate-200 rounded-lg p-2 text-center outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-5">
                    <div>
                        <label class="block text-xs font-bold text-indigo-600 uppercase mb-1.5">Mids (Max: 30)</label>
                        <div class="relative">
                            <input type="number" step="0.1" min="0" max="30" id="editMids" class="w-full border-2 border-indigo-100 rounded-xl p-3 pl-4 font-bold text-indigo-700 outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition text-lg">
                        </div>
                    </div>