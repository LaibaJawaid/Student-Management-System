<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Modern Gradient Background */
        body { 
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            font-family: 'Inter', system-ui, sans-serif;
            min-height: 100vh;
        }

        /* Animations */
        .fade-in { animation: fadeIn 0.6s ease-out forwards; opacity: 0; transform: translateY(20px); }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }

        .slide-up { animation: slideUp 0.5s ease-out forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }

        /* Card Hover Effects */
        .module-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .module-card:hover { transform: translateY(-8px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2); }
        
        /* FIX: Replaced invalid 'ring' with 'box-shadow' */
        .module-card.active { border-color: #6366f1; background: #eef2ff; box-shadow: 0 0 0 2px #6366f1; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.5); }
    </style>
</head>
<body class="p-4 md:p-8 flex flex-col items-center">

    <!-- Header -->
    <div class="text-center text-white mb-10 fade-in" style="animation-delay: 0.1s;">
        <div class="inline-flex items-center justify-center w-16 h-16 bg-white/20 backdrop-blur-sm rounded-2xl mb-4 shadow-lg">
            <i class="fa-solid fa-graduation-cap text-3xl"></i>
        </div>
        <h1 class="text-4xl font-bold mb-2 tracking-tight">Student Dashboard</h1>
        <p class="text-blue-100 text-lg">Access your academic performance and attendance records</p>
    </div>

    <!-- Main Container -->
    <div class="max-w-4xl w-full space-y-8">

        <!-- 1. Module Selection -->
        <div class="grid md:grid-cols-2 gap-6 fade-in" style="animation-delay: 0.2s;">
            <!-- Attendance Card -->
            <div onclick="selectModule('attendance')" id="card-attendance" 
                 class="module-card bg-white rounded-3xl p-6 cursor-pointer border-4 border-transparent shadow-xl flex items-center gap-5 group">
                <div class="w-16 h-16 rounded-2xl bg-emerald-100 text-emerald-600 flex items-center justify-center text-2xl group-hover:bg-emerald-600 group-hover:text-white transition-colors">
                    <i class="fa-solid fa-calendar-check"></i>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-gray-800">Check Attendance</h3>
                    <p class="text-gray-500 text-sm">View monthly logs & percentage</p>
                </div>
            </div>

            <!-- Marks Card -->
            <div onclick="selectModule('marks')" id="card-marks" 
                 class="module-card bg-white rounded-3xl p-6 cursor-pointer border-4 border-transparent shadow-xl flex items-center gap-5 group">
                <div class="w-16 h-16 rounded-2xl bg-indigo-100 text-indigo-600 flex items-center justify-center text-2xl group-hover:bg-indigo-600 group-hover:text-white transition-colors">
                    <i class="fa-solid fa-chart-simple"></i>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-gray-800">View Results</h3>
                    <p class="text-gray-500 text-sm">Check GPA, Grades & Marks</p>
                </div>
            </div>
        </div>

        <!-- 2. Search & Info Form (Hidden initially) -->
        <div id="search-section" class="bg-white/95 backdrop-blur-xl rounded-3xl shadow-2xl p-8 hidden slide-up border border-white/50">
            <div class="flex items-center gap-3 mb-6 pb-4 border-b border-gray-100">
                <i class="fa-solid fa-filter text-indigo-500 text-xl"></i>
                <h2 class="text-2xl font-bold text-gray-800" id="search-title">Search Details</h2>
            </div>

            <form onsubmit="handleSearch(event)" class="space-y-6">
                <div class="grid md:grid-cols-2 gap-6">
                    <!-- Roll No -->
                    <div class="space-y-2">
                        <label class="text-sm font-semibold text-gray-600 ml-1">Roll Number</label>
                        <div class="relative">
                            <i class="fa-solid fa-id-card absolute left-4 top-3.5 text-gray-400"></i>
                            <input type="text" id="rollno" placeholder="e.g. 23-CS-01" required
                                   class="w-full pl-11 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition font-medium text-gray-700">
                        </div>
                    </div>

                    <!-- Name -->
                    <div class="space-y-2">
                        <label class="text-sm font-semibold text-gray-600 ml-1">Student Name</label>
                        <div class="relative">
                            <i class="fa-solid fa-user absolute left-4 top-3.5 text-gray-400"></i>
                            <input type="text" id="name" placeholder="Enter your full name" required
                                   class="w-full pl-11 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition font-medium text-gray-700">
                        </div>
                    </div>

                    <!-- Batch -->
                    <div class="space-y-2">
                        <label class="text-sm font-semibold text-gray-600 ml-1">Batch</label>
                        <input type="text" id="batch" placeholder="e.g. 23 Fall" 
                               class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition font-medium text-gray-700">
                    </div>

                    <!-- Department -->
                    <div class="space-y-2">
                        <label class="text-sm font-semibold text-gray-600 ml-1">Department</label>
                        <input type="text" id="dept" placeholder="e.g. CS" 
                               class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition font-medium text-gray-700">
                    </div>

                    <!-- Course Selection (Full Width) -->
                    <div class="md:col-span-2 space-y-2">
                        <label class="text-sm font-semibold text-gray-600 ml-1">Select Course</label>
                        <div class="relative">
                            <i class="fa-solid fa-book-open absolute left-4 top-3.5 text-gray-400"></i>
                            <select id="course" required
                                    class="w-full pl-11 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition font-medium text-gray-700 appearance-none cursor-pointer">
                                <option value="" disabled selected>Select a registered course...</option>
                                <!-- Populated via JS -->
                            </select>
                            <i class="fa-solid fa-chevron-down absolute right-4 top-4 text-gray-400 pointer-events-none"></i>
                        </div>
                        <p class="text-xs text-gray-400 ml-1">* Select the exact course code you are enrolled in.</p>
                    </div>
                </div>

                <button type="submit" id="searchBtn"
                        class="w-full bg-gradient-to-r from-indigo-600 to-blue-600 hover:from-indigo-700 hover:to-blue-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-indigo-500/30 transition transform hover:-translate-y-0.5 active:scale-95 flex items-center justify-center gap-2">
                    <i class="fa-solid fa-magnifying-glass"></i> Search Record
                </button>
            </form>
        </div>

        <!-- 3. Results Display (Dynamic) -->
        <div id="results-area" class="hidden space-y-6 slide-up">
            
            <!-- Student Profile Summary -->
            <div class="bg-white rounded-3xl p-6 shadow-lg border border-white/50 flex flex-col md:flex-row items-center gap-6">
                <div class="w-16 h-16 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center text-2xl font-bold border-4 border-white shadow-sm">
                    <span id="profile-initial">S</span>
                </div>
                <div class="text-center md:text-left flex-1">
                    <h3 class="text-xl font-bold text-gray-800" id="display-name">Student Name</h3>
                    <p class="text-gray-500 text-sm font-medium"><span id="display-roll">23-CS-01</span> • <span id="display-batch">23 Fall</span> • <span id="display-dept">CS</span></p>
                </div>
                <div class="px-5 py-2 bg-indigo-50 text-indigo-700 rounded-xl text-sm font-bold border border-indigo-100 shadow-sm">
                    <i class="fa-solid fa-book mr-2"></i><span id="display-course">Course Code</span>
                </div>
            </div>

            <!-- Content Container -->
            <div id="result-content" class="bg-white/95 backdrop-blur rounded-3xl p-8 shadow-2xl min-h-[300px]">
                <!-- Results will be injected here via JS -->
                <div class="flex flex-col items-center justify-center h-full text-gray-400 py-12">
                    <i class="fa-solid fa-spinner fa-spin text-4xl mb-4 text-indigo-500"></i>
                    <p>Fetching data from secure database...</p>
                </div>
            </div>

        </div>

    </div>

    <script>
        const FASTAPI_URL = "http://127.0.0.1:8000";
        let currentModule = null;

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchCourses();
        });

        async function fetchCourses() {
            try {
                // Fetching course list for dropdown
                const response = await fetch(`${FASTAPI_URL}/courses/`);
                if (response.ok) {
                    const courses = await response.json();
                    const select = document.getElementById('course');
                    select.innerHTML = '<option value="" disabled selected>Select a registered course...</option>';
                    courses.forEach(c => {
                        const option = document.createElement('option');
                        option.value = c;
                        option.text = c;
                        select.appendChild(option);
                    });
                }
            } catch (e) {
                console.error("API Error:", e);
                // Fallback for UI testing if API is down
                const select = document.getElementById('course');
                select.innerHTML += '<option value="23/Fall-DBMS">23/Fall-DBMS</option>';
            }
        }

        // --- UI Logic ---
        function selectModule(module) {
            currentModule = module;
            document.getElementById('search-section').classList.remove('hidden');
            
            // Visual feedback
            document.querySelectorAll('.module-card').forEach(c => c.classList.remove('active', 'border-indigo-500'));
            document.getElementById(`card-${module}`).classList.add('active', 'border-indigo-500');
            
            // Update Title
            const title = module === 'attendance' ? 'Search Attendance Records' : 'View Academic Results';
            document.getElementById('search-title').innerText = title;
            
            // Scroll to search
            document.getElementById('search-section').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        async function handleSearch(e) {
            e.preventDefault();
            const btn = document.getElementById('searchBtn');
            const resultsArea = document.getElementById('results-area');
            const resultContent = document.getElementById('result-content');
            
            // Get Values
            const rollno = document.getElementById('rollno').value.trim();
            const course = document.getElementById('course').value;
            const name = document.getElementById('name').value;
            const batch = document.getElementById('batch').value;
            const dept = document.getElementById('dept').value;

            // UI Loading State
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Searching...';
            resultsArea.classList.remove('hidden');
            resultContent.innerHTML = `
                <div class="text-center py-12">
                    <i class="fa-solid fa-satellite-dish fa-bounce text-4xl text-indigo-500 mb-4"></i>
                    <p class="text-gray-500 font-medium">Retrieving records from Firebase...</p>
                </div>`;

            // Update Profile Header
            document.getElementById('display-name').innerText = name;
            document.getElementById('profile-initial').innerText = name.charAt(0).toUpperCase();
            document.getElementById('display-roll').innerText = rollno;
            document.getElementById('display-batch').innerText = batch;
            document.getElementById('display-dept').innerText = dept;
            document.getElementById('display-course').innerText = course;

            try {
                if (currentModule === 'marks') {
                    await fetchMarksResult(course, rollno);
                } else {
                    await fetchAttendanceResult(course, rollno);
                }
            } catch (error) {
                resultContent.innerHTML = `
                    <div class="text-center py-10 text-red-500">
                        <i class="fa-solid fa-triangle-exclamation text-4xl mb-3"></i>
                        <h3 class="text-xl font-bold">Record Not Found</h3>
                        <p>${error.message}</p>
                        <p class="text-sm text-gray-400 mt-2">Check Roll No or Course Code.</p>
                    </div>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-magnifying-glass"></i> Search Record';
                resultsArea.scrollIntoView({ behavior: 'smooth' });
            }
        }

        // --- Fetch Logic (Marks) ---
        async function fetchMarksResult(course, rollno) {
            const container = document.getElementById('result-content');
            
            try {
                const res = await fetch(`${FASTAPI_URL}/results/student/${course}/${rollno}`);
                
                if (!res.ok) throw new Error("Result not found in database.");
                
                const data = await res.json();
                
                const gradeColors = {
                    'A': 'bg-emerald-500', 'B': 'bg-blue-500', 'C': 'bg-yellow-500', 'D': 'bg-orange-500', 'F': 'bg-red-500'
                };
                const bg = gradeColors[data.grade?.[0]] || 'bg-gray-500';

                container.innerHTML = `
                    <div class="text-center mb-8">
                        <span class="text-xs font-bold text-gray-400 uppercase tracking-widest">Overall Grade</span>
                        <div class="w-32 h-32 rounded-full ${bg} text-white flex items-center justify-center text-5xl font-extrabold mx-auto mt-4 shadow-xl border-4 border-white ring-4 ring-gray-100">
                            ${data.grade || 'N/A'}
                        </div>
                        <div class="mt-6 flex justify-center gap-8 border-b border-gray-100 pb-6">
                            <div class="text-center">
                                <p class="text-xs text-gray-500 font-bold uppercase tracking-wider">GPA</p>
                                <p class="text-3xl font-extrabold text-gray-800">${data.gpa || 0.0}</p>
                            </div>
                            <div class="text-center">
                                <p class="text-xs text-gray-500 font-bold uppercase tracking-wider">Percentage</p>
                                <p class="text-3xl font-extrabold text-gray-800">${data.percentage || 0}%</p>
                            </div>
                        </div>
                    </div>

                    <h3 class="text-lg font-bold text-gray-700 mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-list-check text-indigo-500"></i> Component Breakdown
                    </h3>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                        ${generateMarkCard("Mids", data.components?.mids_marks, 30)}
                        ${generateMarkCard("Finals", data.components?.finals_marks, 50)}
                        ${generateMarkCard("Sess", data.components?.sessional, 10)}
                        ${generateMarkCard("Assg", data.components?.assignment, 5)}
                        ${generateMarkCard("Quiz", data.components?.quiz, 5)}
                    </div>
                    
                    <div class="mt-8 pt-4 flex justify-between items-center bg-gray-50 p-4 rounded-xl border border-gray-100">
                        <span class="text-sm font-bold text-gray-500 uppercase">Final Status</span>
                        <span class="px-5 py-1.5 rounded-lg text-sm font-bold ${data.status === 'Pass' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                            ${data.status || 'Unknown'}
                        </span>
                    </div>
                `;

            } catch (error) {
                throw error;
            }
        }

        function generateMarkCard(title, obtained, total) {
            return `
                <div class="bg-white rounded-xl p-4 text-center border border-gray-100 shadow-sm hover:shadow-md transition">
                    <p class="text-[10px] text-gray-400 font-bold uppercase mb-1 tracking-wider">${title}</p>
                    <p class="text-2xl font-bold text-indigo-600">${obtained || 0}</p>
                    <div class="w-full bg-gray-100 h-1 mt-2 rounded-full overflow-hidden">
                        <div class="bg-indigo-500 h-full" style="width: ${(obtained/total)*100}%"></div>
                    </div>
                    <p class="text-[10px] text-gray-400 mt-1">out of ${total}</p>
                </div>
            `;
        }

        // --- Fetch Logic (Attendance) ---
        async function fetchAttendanceResult(course, rollno) {
            const container = document.getElementById('result-content');
            
            // Try to find student in the course list
            const res = await fetch(`${FASTAPI_URL}/students/by-course/${course}`);
            if(!res.ok) throw new Error("Course data not found in Firebase.");
            
            const students = await res.json();
            const student = students.find(s => s.rollno === rollno);
            
            if (!student) throw new Error("Roll Number not enrolled in this course.");

            // Determine status
            const status = student.status || 'Not Marked';
            let statusColor = 'text-gray-500 bg-gray-100';
            if(status === 'Present') statusColor = 'text-green-600 bg-green-50 border-green-200';
            if(status === 'Absent') statusColor = 'text-red-600 bg-red-50 border-red-200';
            if(status === 'Late') statusColor = 'text-yellow-600 bg-yellow-50 border-yellow-200';

            container.innerHTML = `
                <div class="grid md:grid-cols-2 gap-8 items-center">
                    <div class="text-center md:text-left">
                         <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">Latest Session Status</h3>
                         <div class="inline-flex items-center gap-3 px-8 py-5 rounded-2xl text-3xl font-bold ${statusColor} border shadow-sm">
                            <i class="fa-solid ${status === 'Present' ? 'fa-check' : 'fa-xmark'}"></i>
                            ${status}
                         </div>
                         <p class="text-xs text-gray-400 mt-3 font-medium">
                            <i class="fa-regular fa-clock mr-1"></i> Recorded for latest session
                         </p>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="bg-blue-50 p-5 rounded-2xl flex justify-between items-center border border-blue-100">
                            <div>
                                <h4 class="text-blue-900 font-bold">Total Sessions</h4>
                                <p class="text-blue-600 text-xs">Semester To Date</p>
                            </div>
                            <span class="text-3xl font-bold text-blue-700">1</span>
                        </div>
                        
                        <div class="bg-gray-50 p-5 rounded-2xl border border-gray-200">
                            <h4 class="text-gray-700 font-bold mb-2">Overall Performance</h4>
                            <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-200">
                                <div class="bg-indigo-600 h-2.5 rounded-full" style="width: ${status === 'Present' ? '100' : '0'}%"></div>
                            </div>
                            <p class="text-xs text-right text-gray-500 mt-1 font-bold">${status === 'Present' ? '100%' : '0%'}</p>
                        </div>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>